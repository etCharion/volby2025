<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studentské volby: D'Hondtův přepočet mandátů</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .seat {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            margin: 1px;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        .seats-grid {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .pie-chart-container {
            max-width: 500px;
            margin: 0 auto;
        }
        .pie-chart-svg { display: block; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useMemo } = React;

    // --- 1. DATA A KONSTANTY ---

    const SEATS_COUNT = 200;
    const QUORUM_PERCENTAGE = 5;
    const VOTE_SCALING_FACTOR = 1000;
    
    const initialPartiesData = [
        { name: 'STAN', žáci: 35, učitelé: 4, color: '#34D399' },
        { name: 'Spolu', žáci: 26, učitelé: 4, color: '#3B82F6' },
        { name: 'Piráti', žáci: 24, učitelé: 1, color: '#8B5CF6' },
        { name: 'Motoristé', žáci: 5, učitelé: 1, color: '#FCD34D' },
        { name: 'Rebelové', žáci: 3, učitelé: 1, color: '#F87171' },
        { name: 'Voluntia', žáci: 3, učitelé: 0, color: '#2DD4BF' },
        { name: 'Ano', žáci: 2, učitelé: 0, color: '#10B981' },
        { name: 'Koruna', žáci: 1, učitelé: 1, color: '#9CA3AF' },
        { name: 'SPD', žáci: 1, učitelé: 0, color: '#DC2626' },
        { name: 'MZH', žáci: 1, učitelé: 0, color: '#C084FC' },
        { name: 'Generace', žáci: 1, učitelé: 0, color: '#F472B6' },
        { name: 'Levice', žáci: 1, učitelé: 0, color: '#FBBF24' },
        { name: 'SMS', žáci: 1, učitelé: 0, color: '#60A5FA' },
        { name: 'Přísaha', žáci: 1, učitelé: 0, color: '#A78BFA' },
    ];
    
    const initialTurnoutData = {
        žáci: { valid: 105, total: 182 },
        učitelé: { valid: 11, total: 11 },
    };

    // --- 2. VÝPOČET MANDÁTŮ (D'HONDT) ---

    const dhondt = (eligibleParties, totalSeats) => {
        if (!eligibleParties.length) return [];
        let currentSeats = eligibleParties.map(p => ({
            name: p.name,
            votes: p.votes,
            color: p.color,
            seats: 0,
            quotient: p.votes
        }));
        
        for (let i = 0; i < totalSeats; i++) {
            let winner = currentSeats.reduce((max, party) => 
                (party.quotient > max.quotient) ? party : max, 
                { quotient: -1 }
            );
            if (winner.name) {
                winner.seats++;
                winner.quotient = winner.votes / (winner.seats + 1);
            } else {
                break;
            }
        }
        return currentSeats;
    };

    const calculateResults = (mode) => {
        const partiesWithTotalVotes = initialPartiesData.map(p => ({
            ...p,
            votes: mode === 'students' ? p.žáci : (p.žáci + p.učitelé),
        }));

        const totalValidRawVotes = partiesWithTotalVotes.reduce((sum, p) => sum + p.votes, 0);
        const totalValidScaledVotes = totalValidRawVotes * VOTE_SCALING_FACTOR;
        const quorumThreshold = totalValidScaledVotes * (QUORUM_PERCENTAGE / 100);

        const eligibleParties = partiesWithTotalVotes
            .map(p => ({ 
                ...p, 
                scaledVotes: p.votes * VOTE_SCALING_FACTOR,
                passedQuorum: (p.votes * VOTE_SCALING_FACTOR) >= quorumThreshold
            }))
            .filter(p => p.passedQuorum);
            
        const dhondtResults = dhondt(
            eligibleParties.map(p => ({ name: p.name, votes: p.scaledVotes, color: p.color })),
            SEATS_COUNT
        );

        const finalResultsMap = new Map(dhondtResults.map(p => [p.name, p]));
        
        const finalResults = partiesWithTotalVotes.map(party => {
            const result = finalResultsMap.get(party.name) || { seats: 0 };
            const scaledVotes = party.votes * VOTE_SCALING_FACTOR;
            const passedQuorum = scaledVotes >= quorumThreshold;

            return {
                name: party.name,
                rawVotes: party.votes,
                scaledVotes: scaledVotes,
                totalScaledVotes: totalValidScaledVotes,
                percentage: (party.votes / totalValidRawVotes) * 100,
                seats: result.seats,
                color: party.color,
                passedQuorum: passedQuorum,
            };
        }).sort((a, b) => b.seats - a.seats || b.rawVotes - a.rawVotes);
        
        const eligibleVoters = mode === 'students' 
            ? initialTurnoutData.žáci.total 
            : (initialTurnoutData.žáci.total + initialTurnoutData.učitelé.total);
        const turnoutValidVotes = partiesWithTotalVotes.reduce((sum, p) => sum + p.votes, 0);
        const turnout = (turnoutValidVotes / eligibleVoters) * 100;
        const allocatedSeats = finalResults.reduce((sum, p) => sum + p.seats, 0);

        return {
            results: finalResults,
            totalValidRawVotes: turnoutValidVotes,
            totalValidScaledVotes,
            quorumThreshold,
            turnout,
            eligibleVoters,
            allocatedSeats
        };
    };
    
    // --- 3. KOMPONENTY PRO VIZUALIZACI ---

    const Icon = ({ name, className }) => {
        const icons = {
            'bar-chart': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>,
            'pie-chart': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
            'chair': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 5v14h14V5H5zm0 14v-4h14v4H5zm0-4V5h14v10H5zM9 13v6M15 13v6M5 9h14M5 11h14"></path></svg>
        };
        return icons[name] || null;
    };

    const SeatsLayout = ({ results }) => {
        const seats = [];
        results.forEach(p => {
            for (let i = 0; i < p.seats; i++) {
                seats.push({ name: p.name, color: p.color });
            }
        });
        while (seats.length < SEATS_COUNT) {
            seats.push({ name: 'Neobsazeno', color: '#E5E7EB' });
        }
        return (
            <div className="seats-grid">
                {seats.map((seat, index) => (
                    <div 
                        key={index} 
                        className="seat" 
                        style={{ backgroundColor: seat.color }}
                        title={`Mandát č. ${index + 1}: ${seat.name}`}
                    ></div>
                ))}
            </div>
        );
    };
    
    const BarChart = ({ results, valueKey, label }) => {
        const maxValue = results.reduce((max, p) => Math.max(max, p[valueKey]), 0);
        return (
            <div className="p-4 bg-white rounded-xl shadow-lg">
                <h3 className="text-xl font-semibold mb-4 text-center">{label}</h3>
                <div className="flex flex-col space-y-2">
                    {results.map(p => (
                        <div key={p.name} className="flex items-center">
                            <span className="w-24 text-sm font-medium shrink-0">{p.name}</span>
                            <div className="flex-grow bg-gray-200 rounded-full h-8 ml-4 relative overflow-hidden">
                                <div 
                                    className="h-8 rounded-full" 
                                    style={{ 
                                        width: `${(p[valueKey] / (maxValue || 1)) * 100}%`, 
                                        backgroundColor: p.color 
                                    }}
                                ></div>
                                <span className="absolute right-2 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-800">
                                    {valueKey === 'seats' ? p[valueKey] : p[valueKey].toFixed(2) + '%'}
                                </span>
                            </div>
                            {valueKey === 'seats' && p.seats === 0 && !p.passedQuorum && (
                                <span className="ml-2 text-red-500 text-xs font-semibold" title="Strana neprošla 5% kvórem">KVÓRUM</span>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    const describeArc = (x, y, radius, startAngle, endAngle) => {
        const start = polarToCartesian(x, y, radius, endAngle);
        const end = polarToCartesian(x, y, radius, startAngle);
        const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';
        const d = [
            'M', x, y,
            'L', start.x, start.y,
            'A', radius, radius, 0, largeArcFlag, 0, end.x, end.y,
            'Z'
        ].join(' ');
        return d;
    };

    const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    };

    const PieChart = ({ results }) => {
        const relevantResults = results.filter(p => p.percentage > 0);
        const totalEligiblePercentage = relevantResults
            .filter(p => p.passedQuorum)
            .reduce((sum, p) => sum + p.percentage, 0);

        const nonZeroEligibleResults = relevantResults.filter(p => p.passedQuorum && p.percentage > 0);
        if (nonZeroEligibleResults.length === 0) {
            return <p className="text-center text-gray-500 p-8">Žádná strana nepřekročila kvórum, graf nelze vytvořit.</p>;
        }

        const SVG_SIZE = 400;
        const CENTER = SVG_SIZE / 2;
        const RADIUS = CENTER * 0.9;
        let cumulativeAngle = 0;

        const slices = nonZeroEligibleResults.map((p) => {
            const angle = (p.percentage / totalEligiblePercentage) * 360;
            const startAngle = cumulativeAngle;
            const endAngle = cumulativeAngle + angle;
            const path = describeArc(CENTER, CENTER, RADIUS, startAngle, endAngle);
            cumulativeAngle = endAngle;
            return { name: p.name, percentage: p.percentage, color: p.color, path };
        });
        
        const failedParties = relevantResults.filter(p => !p.passedQuorum);

        return (
            <div className="p-4 bg-white rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-center gap-8">
                <div className="pie-chart-container w-full md:w-1/2">
                    <h3 className="text-xl font-semibold mb-3 text-center">Rozdělení hlasů stran, které prošly kvórem</h3>
                    <svg 
                        className="pie-chart-svg" 
                        width={SVG_SIZE} 
                        height={SVG_SIZE} 
                        viewBox={`0 0 ${SVG_SIZE} ${SVG_SIZE}`}
                        role="img"
                        aria-labelledby="pie-title"
                    >
                        <title id="pie-title">Rozdělení hlasů podle stran, které prošly kvórem</title>
                        {slices.map((slice, index) => (
                            <path
                                key={index}
                                d={slice.path}
                                fill={slice.color}
                                stroke="#ffffff"
                                strokeWidth="1"
                                title={`${slice.name}: ${slice.percentage.toFixed(2)}%`}
                            />
                        ))}
                    </svg>
                </div>

                <div className="w-full md:w-1/2 flex flex-col p-4">
                    <h4 className="font-bold mb-2">Legenda a Procenta:</h4>
                    {nonZeroEligibleResults.map(p => (
                        <div key={p.name} className="flex items-center space-x-2 py-1">
                            <div className="w-4 h-4 rounded-sm" style={{ backgroundColor: p.color }}></div>
                            <span className="text-sm flex-grow">{p.name}</span>
                            <span className="text-sm font-semibold">{p.percentage.toFixed(2)}%</span>
                        </div>
                    ))}
                    
                    {failedParties.length > 0 && (
                        <div className="pt-3 border-t mt-3 border-red-200">
                            <p className="text-sm font-bold text-red-500 mb-1">
                                Neprošly 5% kvórem ({failedParties.reduce((sum, p) => sum + p.percentage, 0).toFixed(2)}% hlasů propadlo):
                            </p>
                            {failedParties.map(p => (
                                <p key={p.name} className="text-xs text-gray-600 ml-2">
                                    <span className="inline-block w-2 h-2 rounded-full mr-1" style={{ backgroundColor: p.color }}></span>
                                    {p.name}: {p.percentage.toFixed(2)}%
                                </p>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // --- 4. HLAVNÍ KOMPONENTA (bez simulace) ---
    
    const App = () => {
        const [dataMode, setDataMode] = useState('combined'); // 'students' | 'combined'
        const [visualizationMode, setVisualizationMode] = useState('seats'); // 'percentage' | 'seats' | 'chairs'
        
        const results = useMemo(() => calculateResults(dataMode), [dataMode]);

        const visualizationTitle = useMemo(() => {
            const modeText = dataMode === 'students' ? 'Studentské hlasy (Žáci)' : 'Celkové hlasy (Žáci + Učitelé)';
            if (visualizationMode === 'percentage') return `${modeText}: Rozdělení v procentech (Strany, které prošly kvórem)`;
            if (visualizationMode === 'seats' || visualizationMode === 'chairs') return `${modeText}: Rozdělení ${SEATS_COUNT} mandátů`;
            return '';
        }, [dataMode, visualizationMode]);

        const getVisualizationData = () => {
            const data = results.results.filter(p => p.rawVotes > 0);
            return data.sort((a, b) => b.seats - a.seats || b.percentage - a.percentage);
        };
        const vizData = getVisualizationData();

        const turnoutDisplay = useMemo(() => {
            const totalVoters = initialTurnoutData.žáci.total + initialTurnoutData.učitelé.total;
            const eligibleVoters = dataMode === 'students' ? initialTurnoutData.žáci.total : totalVoters;
            return {
                label: dataMode === 'students' ? 'Účast studentů' : 'Celková účast',
                valid: results.totalValidRawVotes,
                total: eligibleVoters,
                percentage: results.turnout.toFixed(2)
            };
        }, [dataMode, results]);

        const Visualization = () => {
            if (visualizationMode === 'seats') {
                return <BarChart results={vizData} valueKey="seats" label={visualizationTitle} />;
            } else if (visualizationMode === 'percentage') {
                return <PieChart results={vizData} label={visualizationTitle} />;
            } else if (visualizationMode === 'chairs') {
                return <SeatsLayout results={vizData} />;
            }
            return null;
        };

        return (
            <div className="p-4 sm:p-8 min-h-screen">
                <div className="max-w-6xl mx-auto">
                    <h1 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-indigo-500 pb-2">
                        Školní volby 2024: D'Hondtův přepočet mandátů ({SEATS_COUNT} Mandátů)
                    </h1>
                    
                    {/* Panel s přepínači a informacemi */}
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        {/* 1. Vyberte sadu hlasů */}
                        <div>
                            <p className="text-sm font-semibold text-gray-600 mb-2">1. Vyberte sadu hlasů:</p>
                            <div className="flex space-x-2">
                                <button 
                                    onClick={() => setDataMode('students')} 
                                    className={`px-4 py-2 rounded-full text-sm font-bold transition ${dataMode === 'students' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Jen Žáci ({initialTurnoutData.žáci.valid})
                                </button>
                                <button 
                                    onClick={() => setDataMode('combined')} 
                                    className={`px-4 py-2 rounded-full text-sm font-bold transition ${dataMode === 'combined' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Žáci + Učitelé ({initialTurnoutData.žáci.valid + initialTurnoutData.učitelé.valid})
                                </button>
                            </div>
                        </div>

                        {/* 2. Vyberte vizualizaci */}
                        <div>
                            <p className="text-sm font-semibold text-gray-600 mb-2">2. Vyberte vizualizaci:</p>
                            <div className="flex space-x-2">
                                <button 
                                    onClick={() => setVisualizationMode('percentage')} 
                                    className={`px-3 py-2 rounded-lg text-sm transition flex items-center ${visualizationMode === 'percentage' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    title="Procentuální rozdělení hlasů (Koláčový graf)"
                                >
                                    <Icon name="pie-chart" className="w-5 h-5 mr-1" /> Procenta
                                </button>
                                <button 
                                    onClick={() => setVisualizationMode('seats')} 
                                    className={`px-3 py-2 rounded-lg text-sm transition flex items-center ${visualizationMode === 'seats' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    title="Získané mandáty (Sloupce)"
                                >
                                    <Icon name="bar-chart" className="w-5 h-5 mr-1" /> Mandáty
                                </button>
                                <button 
                                    onClick={() => setVisualizationMode('chairs')} 
                                    className={`px-3 py-2 rounded-lg text-sm transition flex items-center ${visualizationMode === 'chairs' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    title="Křesla (Vizualizace 200 mandátů)"
                                >
                                    <Icon name="chair" className="w-5 h-5 mr-1" /> Křesla
                                </button>
                            </div>
                        </div>
                        
                        {/* 3. Účast (bez tlačítka simulace) */}
                        <div className="flex items-center">
                            <div className="bg-gray-100 p-3 rounded-lg text-center w-full">
                                <p className="text-xs text-gray-600">{turnoutDisplay.label}</p>
                                <p className="text-2xl font-extrabold text-gray-800">{turnoutDisplay.percentage}%</p>
                                <p className="text-xs text-gray-500">({turnoutDisplay.valid} z {turnoutDisplay.total} voličů)</p>
                            </div>
                        </div>

                    </div>
                    
                    {/* HLAVNÍ VIZUALIZACE */}
                    <h2 className="text-2xl font-bold text-gray-700 mb-6 text-center">{visualizationTitle}</h2>
                    <div className="mb-8">
                        <Visualization />
                    </div>

                    {/* Tabulka s detailními výsledky */}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold text-gray-700 mb-4">Detailní výsledky voleb</h2>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Strana</th>
                                        <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Hlasy ({dataMode === 'students' ? 'Žáci' : 'Celkem'})</th>
                                        <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Procenta</th>
                                        <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Kvórum 5%</th>
                                        <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Mandáty ({SEATS_COUNT})</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {results.results.map(p => (
                                        <tr key={p.name} className={!p.passedQuorum && p.seats === 0 ? 'opacity-60' : ''}>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                                                <span className="inline-block w-3 h-3 rounded-full mr-2" style={{ backgroundColor: p.color }}></span>
                                                {p.name}
                                            </td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-500">
                                                {p.rawVotes}
                                            </td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-500">
                                                {p.percentage.toFixed(2)}%
                                            </td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-center">
                                                <span className={`font-bold ${p.passedQuorum ? 'text-green-600' : 'text-red-500'}`}>
                                                    {p.passedQuorum ? 'ANO' : 'NE'}
                                                </span>
                                            </td>
                                            <td className="px-3 py-2 whitespace-nowrap text-lg font-extrabold text-center">
                                                {p.seats}
                                            </td>
                                        </tr>
                                    ))}
                                    <tr className="bg-gray-100 font-bold">
                                        <td className="px-3 py-2 whitespace-nowrap text-base">CELKEM</td>
                                        <td className="px-3 py-2 whitespace-nowrap text-base text-center">{results.totalValidRawVotes}</td>
                                        <td className="px-3 py-2 whitespace-nowrap text-base text-center">100.00%</td>
                                        <td className="px-3 py-2 whitespace-nowrap text-base text-center">-</td>
                                        <td className="px-3 py-2 whitespace-nowrap text-lg text-center text-indigo-600">{results.allocatedSeats}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <p className="mt-4 text-xs text-gray-500">
                            *Poznámka: Pro smysluplné rozdělení 200 mandátů je celkový počet hlasů ({results.totalValidRawVotes}) automaticky vynásoben faktorem <strong>{VOTE_SCALING_FACTOR}</strong> (kvórum se počítá z této škálované hodnoty: <strong>{results.quorumThreshold.toLocaleString('cs-CZ')}</strong> hlasů).
                        </p>
                    </div>
                </div>
            </div>
        );
    };

    // Renderování aplikace
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
</script>
</body>
</html>
